<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>キッチン | 栄ホスト</title>
    <style>
        body { font-family: sans-serif; background-color: #333; color: white; margin: 0; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #555; }
        .header h1 { margin: 0; }
        .header a { color: #8af; text-decoration: none; }
        .orders-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .order-ticket { background-color: #f5f5f5; color: #333; border-radius: 8px; padding: 15px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); display: flex; flex-direction: column; }
        .order-ticket-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px dashed #999; padding-bottom: 10px; margin-bottom: 10px; }
        .order-ticket-header span { font-size: 0.9rem; color: #666; }
        .order-ticket ul { list-style: none; padding: 0; margin: 0; flex-grow: 1; }
        .order-ticket li { display: flex; justify-content: space-between; font-size: 1.2rem; padding: 8px 0; }
        .order-ticket li span:first-child { font-weight: bold; }
        .complete-button { width: 100%; padding: 12px; font-size: 1rem; background-color: #ffc107; color: #333; border: none; border-radius: 5px; cursor: pointer; margin-top: 15px; font-weight: bold; }
        .complete-button:hover { background-color: #e0a800; }
    </style>
</head>
<body>

    <div class="header">
        <h1>キッチンオーダー</h1>
        <a href="menu.html">メニューに戻る</a>
    </div>

    <div class="orders-container" id="orders-list">
        <!-- ここに調理中の注文がリアルタイムで表示される -->
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script>
        // --- Firebase設定 ---
        const firebaseConfig = {
            apiKey: "AIzaSyABdNLXLt9eFECppeOo_rHS-V4N7v0Vjg0",
            authDomain: "sakae-host-asakulove.firebaseapp.com",
            projectId: "sakae-host-asakulove",
            storageBucket: "sakae-host-asakulove.appspot.com",
            messagingSenderId: "949047143177",
            appId: "1:949047143177:web:a3ef7fcd1c505be920c1d8",
            measurementId: "G-BCLM11PX1R"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const ordersList = document.getElementById('orders-list');

        // --- 注文データをリアルタイムで監視 ---
        // 'orders'コレクションの'status'が'cooking'（調理中）のものだけを監視
        db.collection("orders")
          .where("status", "==", "cooking")
          .orderBy("createdAt", "asc") // 古い順に表示
          .onSnapshot((querySnapshot) => {
            ordersList.innerHTML = ''; // 表示を一旦クリア
            querySnapshot.forEach((doc) => {
                const order = doc.data();
                const orderId = doc.id;

                // 注文チケットのHTMLを生成
                const ticket = document.createElement('div');
                ticket.className = 'order-ticket';
                ticket.id = orderId;

                // 注文時刻をフォーマット
                const orderTime = order.createdAt.toDate().toLocaleTimeString('ja-JP');

                // 注文内容のリストを生成
                let itemsHtml = '<ul>';
                order.items.forEach(item => {
                    itemsHtml += `<li><span>${item.name}</span><span>x ${item.quantity}</span></li>`;
                });
                itemsHtml += '</ul>';

                ticket.innerHTML = `
                    <div class="order-ticket-header">
                        <span>注文時刻: ${orderTime}</span>
                        <span>担当: ${order.host}</span>
                    </div>
                    ${itemsHtml}
                    <button class="complete-button" onclick="completeOrder('${orderId}')">調理完了</button>
                `;
                ordersList.appendChild(ticket);
            });
        });

        // --- 調理完了ボタンの処理 ---
               function completeOrder(orderId) {
            if (confirm('この注文の調理を完了し、お客様へ提供しますか？')) { // メッセージも変更
                // Firestoreの該当ドキュメントのstatusを'paid'（支払済＝売上計上済）に更新
                db.collection("orders").doc(orderId).update({
                    status: "paid" // 調理完了で最終的な売上に計上
                })
                .then(() => {
                    console.log("注文が完了しました！");
                })
                .catch((error) => {
                    console.error("更新に失敗しました: ", error);
                });
            }
        }
    </script>

</body>
</html>
